<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="icon" type="image/jpeg" href="jebu.jpg" />
<script src="jquery-2.2.1.js"></script>
<style type="text/css">
html {
	font-family: sans-serif;
}
#managerConnection.broken {
	background-color: red;
	color: white;
}
#managerConnection.broken:AFTER {
	content: "broken";
}
#managerConnection.established {
	background-color: lime;
	color: black;
}
#managerConnection.established:AFTER {
	content: "established";
}
</style>
<title>Jebu Manager</title>
</head>
<body>
	<h1>Jebu Manager</h1>
	<p>
	<label>Manager Connection: <span id="managerConnection"></span></label>
	</p>
	<p>
	<label>Manager Sessions: <span id="managerSessions"></span></label>
	</p>
	<table>
		<thead>
			<tr><th>eventName</th><th>Subscriber</th></tr>
		</thead>
		<tbody></tbody>
	</table>
</body>
<script>
(function () {
    "use strict";
	var uri = "ws://" + location.host + location.pathname + "jebu/manager/",
		Ws, ws, number = 0, t;
    
	
	Ws = function (uri) {
    	var ws, closeHandler;

		closeHandler = $.proxy(function (event) {
			this.connectionBroken();
			try {
				ws.close();
				ws.onerror = null;
				ws.onclose = null;
				ws.onopen = null;
				ws.onmessage = null;
				ws = null;
			} catch (error) { }
			try {
				clearTimeout(t);				
			} catch (error) { }
   			t = setTimeout($.proxy(this.init, this), 3000);
        }, this);
		
		this.connectionEstablished = function () {
			$("#managerConnection").removeClass("broken")
				.addClass("established");
		};
		this.connectionBroken = function () {
			$("#managerConnection").addClass("broken")
				.removeClass("established");
		};

    	this.init = function () {
   			ws = new WebSocket(uri);
			
   			ws.onerror = closeHandler;
   			ws.onclose = closeHandler;
   			ws.onopen = $.proxy(function (evt) {
   				console.log(evt);
   			}, this);
   			
   			ws.onmessage = $.proxy(function (evt) {
   				var json = JSON.parse(evt.data),
   					tbody = $("tbody");
   				tbody.html("");
   				
   				$.each(json.subscriberMap, function (eventName, collection) {
   					$.each(collection, function (idx, subscriberId) {
   						var tr = $("<tr><td></td><td></td></tr>");
   						tr.find("td").eq(0).append(document.createTextNode(eventName));
   						tr.find("td").eq(1).append(document.createTextNode(subscriberId));
   						tbody.append(tr);
   					})
   				});
   				
   				$("#managerSessions").html(json.managerSessions.length);
   				this.connectionEstablished();
   			}, this);
   			
   		};
    	this.ping = function () {
   			try {
   				ws.send("ping");
   				if (ws.readyState !== 1) {
   					closeHandler();
   				}
   			} catch (error) {
   				closeHandler();
   			}
   		};
   		setInterval(this.ping, 5000);
    };
	
    ws = new Ws(uri);
    ws.init();
		
}());
</script>
</html>