<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="icon" type="image/jpeg" href="jebu.jpg" />
<script src="jquery-2.2.1.js"></script>
<style type="text/css">
html {
	font-family: sans-serif;
}
</style>
<title>Jebu Manager</title>
</head>
<body>
	<h1>Jebu Manager</h1>
	<table>
		<thead>
			<tr><th>eventName</th><th>Subscriber</th></tr>
		</thead>
		<tbody></tbody>
	</table>
</body>
<script>
(function () {
    "use strict";
	var uri = "ws://" + location.host + location.pathname + "jebu/manager/",
		Ws, ws;
    
	
	Ws = function (uri) {
    	var ws;
    	
    	return {
    		init : function () {
    			var closeHandler;
    			ws = new WebSocket(uri);
    			closeHandler = $.proxy(function (event) {
    				try {
    					ws.close();
    				} catch (error) { }
    	    		setTimeout(this.init, 3000);
    	        }, this);
    	    	
    			ws.onError = closeHandler;
    			ws.onClose = closeHandler;
    			
    			ws.onmessage = function (evt) {
    				var json = JSON.parse(evt.data),
    					tbody = $("tbody");
    				tbody.html("");
    				
    				$.each(json.subscriberMap, function (eventName, collection) {
    					$.each(collection, function (idx, subscriberId) {
    						var tr = $("<tr><td></td><td></td></tr>");
    						tr.find("td").eq(0).append(document.createTextNode(eventName));
    						tr.find("td").eq(1).append(document.createTextNode(subscriberId));
    						tbody.append(tr);
    					})
    				});
    			};
    		}
    	}
    };
	
    ws = new Ws(uri);
    ws.init();
		
}());
</script>
</html>